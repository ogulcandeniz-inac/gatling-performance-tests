name: Gatling Performance Tests

on:
  push:
    branches: [ main ]

jobs:
  gatling:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: Download Gatling bundle
        run: |
          wget -O gatling-bundle.zip \
            https://repo1.maven.org/maven2/io/gatling/highcharts/gatling-charts-highcharts-bundle/3.9.5/gatling-charts-highcharts-bundle-3.9.5-bundle.zip
          unzip gatling-bundle.zip -d gatling

      - name: Copy Scala simulations into bundle
        run: |
          mkdir -p gatling/gatling-charts-highcharts-bundle-3.9.5/user-files/simulations
          cp src/gatling/scala/simulations/*.scala \
             gatling/gatling-charts-highcharts-bundle-3.9.5/user-files/simulations/

      - name: Verify simulations
        run: |
          ls -l gatling/gatling-charts-highcharts-bundle-3.9.5/user-files/simulations

      - name: Run Petstore CRUD Simulation
        working-directory: gatling/gatling-charts-highcharts-bundle-3.9.5/bin
        run: |
          ./gatling.sh \
            -s simulations.PetstoreCRUDSimulation \
            -nr \
            -rf "$GITHUB_WORKSPACE/results"
